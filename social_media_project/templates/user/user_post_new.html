<!DOCTYPE html>
{% load static %}
{% include 'user/user_nav_bar.html' %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
    <link rel="stylesheet" href="{% static '/css/dashboard.css' %}" />
    <link rel="stylesheet" href="{% static '/css/video.css' %}" />
    <link rel="stylesheet" href="{% static '/css/user_post.css' %}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"/>

   <link rel="stylesheet" href="{% static '/css/add_user.css' %}">

    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        ::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge, and Firefox */
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

</head>
<body>
<div class="main_content" id="post-area">
    <!-- Content will be dynamically populated here -->
</div>

<div id="notification">
    <div id="friendsSuggestionContainer">
        <div id="friendsSuggestionHeader">Friend Suggestions</div>
        <div id="friendSuggestionList">
            <!-- Suggestions will be dynamically populated here -->
        </div>
    </div>
</div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Function to report a post
    function reportPost(postId) {
        $.ajax({
            type: 'GET',
            url: '/report_post_new',  // Change the URL to your report_post endpoint
            data: { post_id: postId },
            success: function(response) {
                // Handle success response if needed
                console.log('Post reported successfully.');
                console.log(postId);
                // Optionally, you can handle UI changes here, like disabling the report link
                alert(response.message);
                fetchDataAndPopulate();
            },
            error: function(xhr, status, error) {
                // Handle error response if needed
                console.error('Error reporting post:', error);
            }
        });
    }

    // Click event handler for the report link
    $(document).on('click', '.report-link', function(event) {
        event.preventDefault(); // Prevent default link behavior
        var postId = $(this).data('post-id'); // Get post ID from data attribute
        reportPost(postId); // Call the function to report the post
    });

     // Function to like a post
    function likePost(postId) {
        $.ajax({
            type: 'GET',
            url: '/like_post_new',  // Change the URL to your report_post endpoint
            data: { post_id: postId },
            success: function(response) {
                // Handle success response if needed
                console.log('Like successfully.');
                console.log(postId);
                // Optionally, you can handle UI changes here, like disabling the report link
<!--                alert(response.message);-->
                fetchDataAndPopulate();
            },
            error: function(xhr, status, error) {
                // Handle error response if needed
                console.error('Error reporting post:', error);
            }
        });
    }

    // Click event handler for the report link
    $(document).on('click', '.like-link', function(event) {
        event.preventDefault(); // Prevent default link behavior
        var postId = $(this).data('post-id'); // Get post ID from data attribute
        likePost(postId); // Call the function to report the post
    });


// Function to comment a post
function commentPost(postId) {
    $.ajax({
        type: 'GET',
        url: '/get_comment',
        data: { post_id: postId },
        success: function(response) {
            // Handle success response
            console.log('Comments successfully fetched.');
            console.log(response);

            // Clear any existing comments
            $('.comments').empty();
        if (response.comments.length === 0) {
        $('.comments').append('<h2>No comments</h2>');
    } else {
            // Iterate over each comment and append it to the comments container


                $('.comments').append('<h2>Comments</h2>');
            $.each(response.comments, function(index, comment) {
                var commentHtml = '<div class="comment">';
                commentHtml += '<div class="comment-content">';
                commentHtml += '<h5 style="margin: auto;">@' + comment.username + '</h5>';
                commentHtml += '<p style="font-size: small;">' + comment.content + '</p>';
                commentHtml += '</div>';
                commentHtml += '</div>';
                $('.comments').append(commentHtml);
            });
            }
        },
        error: function(xhr, status, error) {
            // Handle error response if needed
            console.error('Error fetching comments:', error);
        }
    });
}

// Click event handler for the comment link
$(document).on('click', '.comment-link', function(event) {
    event.preventDefault(); // Prevent default link behavior
    var postId = $(this).data('post-id'); // Get post ID from data attribute
    commentPost(postId); // Call the function to fetch comments
    show_user_form();
});

// Function to show user form
function show_user_form() {
    // Get the comment link elements
    var showFormButtons = document.getElementsByClassName("comment-link");

    // Get the modal container element
    var modalContainer = document.getElementById("modalContainer");

    // Attach click event listener to each comment link
    for (var i = 0; i < showFormButtons.length; i++) {
        showFormButtons[i].onclick = function() {
            modalContainer.style.display = "block";
        }
    }

    // Close the modal when the close button is clicked
    document.getElementsByClassName("close")[0].onclick = function() {
        modalContainer.style.display = "none";
    }

    // Close the modal when clicking outside of it
    window.onclick = function(event) {
        if (event.target == modalContainer) {
            modalContainer.style.display = "none";
        }
    }
}


// Function to add a comment to a post
function addComment(postId, commentText) {
    $.ajax({
        type: 'GET',
        url: '/add_comment',  // URL to your Django view
        data: {
            'post_id': postId,
            'comment_text': commentText
        },
        success: function(response) {
            // Handle success response if needed
            console.log('Comment added successfully.');
            // Optionally, you can handle UI changes here, like displaying a success message
            fetchDataAndPopulate();
        },
        error: function(xhr, status, error) {
            // Handle error response if needed
            console.error('Error adding comment:', error);
        }
    });
}

// Click event handler for adding a comment
$(document).on('click', '.add-comment-link', function(event) {
    event.preventDefault(); // Prevent default link behavior
    var postId = $(this).data('post-id'); // Get post ID from data attribute
    var commentText = $(this).prev('.cmt').val(); // Get comment text
    addComment(postId, commentText); // Call the function to add comment
});

</script>

<script>
    function fetchDataAndPopulate(){
    $(document).ready(function() {
        // Fetch and populate posts
        $.getJSON('/user_post_sample/{{user.user_id}}', function(data) {
            var postsHTML = '';
            $.each(data.Posts, function(index, post) {
                postsHTML += '<div class="post">';
                postsHTML += '<div class="user_post_detail">';
                postsHTML += '<img class="user_profile" src="/media/' + post.profile_picture_url + '">';
                postsHTML += '<div><p>@' + post.user_name + '</p></div>';
                postsHTML += '</div>';
                // Check media type and add accordingly
                if (post.media_type == 'Image') {
                    postsHTML += '<img class="post-img" src="/media/' + post.media_url + '" alt="Post Image" />';
                } else if (post.media_type == 'Video') {
                    postsHTML += '<div class="video-container">';
                    postsHTML += '<video id="myVideo" width="100%" controlsList="nodownload" controls>';
                    postsHTML += '<source src="../media/' + post.media_url + '" type="video/mp4">';
                    postsHTML += 'Your browser does not support the video tag.';
                    postsHTML += '</video>';
                    postsHTML += '<button id="playButton" class="play-button"></button>';
                    postsHTML += '</div>';
                }
                postsHTML += '<div class="post-info">';
                postsHTML += '<div class="interaction">';
<!--                postsHTML += '<a href="/like_post_new?post_id=' + post.post_id + '"><i class="bi bi-heart">&nbsp;' + post.likes_count + '</i></a>';-->
                postsHTML += '<div><a href="#" class="like-link" data-post-id="' + post.post_id + '"><i class="bi bi-heart">&nbsp;' + post.likes_count + '</i></a>';
<!--                postsHTML += '{% if post.likes_count == 0 %}'-->
<!--                postsHTML += '<p class="like_person">No Likes </p>'-->
<!--                postsHTML += '{% elif post.likes_count == 1 %}'-->
<!--                postsHTML += '<p class="like_person">Liked by '+ post.likes_count +' person</p>'-->
<!--                postsHTML += '{% else %}'-->
<!--                postsHTML += '<p class="like_person">Liked by '+ post.likes_count +' people</p>'-->
<!--                postsHTML += '{% endif %}';-->
                    postsHTML += '&nbsp;&nbsp;<a href="#"  class="comment-link" data-post-id="' + post.post_id + '"><i class="bi bi-chat-left-dots">&nbsp;' + post.comments_count + '</i></a>';
                    postsHTML += '</div><div>';
                    postsHTML += '<a href="#" class="report-link" data-post-id="' + post.post_id + '"><i class="bi bi-exclamation-square-fill"><span class="hide-text">Report</span></i></a>';
                    postsHTML += '<a href="/media/' + post.media_url + '" download="POST"><i class="bi bi-arrow-down-circle">&nbsp;</i></a>';
                    postsHTML += '</div>';
                    postsHTML += '</div>';
                    postsHTML += '<div>';
                    postsHTML += '<div class="add-comment">';
                    postsHTML += '<input class="cmt" type="text" placeholder="Add comments">';
                    postsHTML += '<a href="#" class="add-comment-link" data-post-id="' + post.post_id + '"><button><i class="bi bi-arrow-right-square-fill"></i></button></a>';
                    postsHTML += '</div></div>';
                postsHTML += '<div class="post-text">';
                postsHTML += '<b>' + post.post_title + '</b><br>';
                postsHTML += post.content;
                postsHTML += '</div>';
                postsHTML += '</div>';
                postsHTML += '</div>';
            });
            $('#post-area').html(postsHTML);
        });

        // Fetch and populate suggestions
        $.getJSON('/user_post_sample/{{user.user_id}}', function(data) {
            var suggestionsHTML = '';
            $.each(data.follow, function(index, suggestion) {
                suggestionsHTML += '<div class="friendSuggestion">';
                suggestionsHTML += '<div class="friendSuggestionName">' + suggestion.username + '</div>';
                suggestionsHTML += '<a href="/follow/' + suggestion.username + '_' + suggestion.user_id + '"><button class="friendSuggestionButton">follow</button></a>';
                suggestionsHTML += '</div>';
            });
            $('#friendSuggestionList').html(suggestionsHTML);
        });
    });
    }
    window.onload = function() {
        fetchDataAndPopulate();
    };
</script>


<div id="modalContainer" class="modal-container" >
  <div id="signupModal" class="modal" style="width:40%; height:70%">
    <span class="close">&times;</span>
      <div class="comments">
        <div class="comment">
            <div class="comment-content">
<!--               Comment Content -->
            </div>
        </div>
  </div>
</div>

</body>
</html>
